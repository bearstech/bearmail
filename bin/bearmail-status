#!/bin/sh

# bearmail-status - part of bearmail
# # Copyright (C) 2009 Bearstech - http://bearstech.com/
# #
# # This program is free software: you can redistribute it and/or modify
# # it under the terms of the GNU General Public License as published by
# # the Free Software Foundation, either version 3 of the License, or
# # (at your option) any later version.
# #
# # This program is distributed in the hope that it will be useful,
# # but WITHOUT ANY WARRANTY; without even the implied warranty of
# # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# # GNU General Public License for more details.
# #
# # You should have received a copy of the GNU General Public License
# # along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#
# This is a simple script to see the status of Bearmail or to restart services


NAME="BearMail"                             # Name
BM_CONFIG=/etc/bearmail/conf/bearmail.conf  # Bearmail configuration file

if [ ! -f $BM_CONFIG ] ; then
     echo "$NAME seems not configured"
     exit 1
fi

# Read config file if it is present.
if [ -r $BM_CONFIG ]; then
        . $BM_CONFIG
fi

## Start services
start_services() {
        echo -n "."
        $CLAMAV_INIT start    > /dev/null 2>&1
        echo -n "_"
        $CLAMSMTPD_INIT start > /dev/null 2>&1
        echo -n "."
        $DSPAM_INIT start     > /dev/null 2>&1
        echo -n "_"
        $DOVECOT_INIT start   > /dev/null 2>&1
        echo -n "."
        $POSTFIX_INIT start   > /dev/null 2>&1
}

## Stop services
end_services() {
        $CLAMAV_INIT stop    > /dev/null 2>&1
        $CLAMSMTPD_INIT stop > /dev/null 2>&1
        $DSPAM_INIT stop     > /dev/null 2>&1
        $DOVECOT_INIT stop   > /dev/null 2>&1
        $POSTFIX_INIT stop   > /dev/null 2>&1
}



###########################################################################
## Main Body

case ${1} in
    restart)
	echo "Restarting ${DESC}"
        end_services
	sleep 1
        start_services
	echo "."
        ;;
    status|*)
	BEARMAIL_OFF=0
	PID_POSTFIX=$(pidof master)
	PID_DOVECOT=$(pidof dovecot)
	PID_CLAMAV=$(pidof clamd)
	PID_DSPAM=$(pidof dspam)
	PID_CLAMSMTP=$(pidof clamsmtpd)
	if [ -z $PID_POSTFIX ] && [ -z $PID_DOVECOT ] && [ -z $PID_CLAMAV ] \
           && [ -z $PID_DSPAM ] && [ -z $PID_CLAMSMTP ] ; then
	     echo "$NAME is not running"
	     BEARMAIL_OFF=1
        fi
        if [ $BEARMAIL_OFF = 0 ] ; then
          echo "$NAME status :"
          ERROR=0
          if [ -z $PID_POSTFIX ] ; then
              echo " - Postfix is not running"
              ERROR=1
          fi
          if [ -z $PID_DOVECOT ] ; then
              echo " - Dovecot is not running"
              ERROR=1
          fi
          if [ -z $PID_CLAMAV ] ; then
              echo " - Clamav is not running"
              ERROR=1
          fi
          if [ -z $PID_DSPAM ] ; then
              echo " - Dspam is not running"
              ERROR=1
          fi
          if [ -z $PID_CLAMSMTP ] ; then
              echo " - ClamSMTP is not running"
              ERROR=1
          fi
          if [ $ERROR = 1 ] ; then
              echo "Bearmail is not operationnel"
          fi
          if [ $ERROR = 0 ] ; then
              echo "Bearmail is running"
          fi
        fi
        ;;
esac

exit 0
