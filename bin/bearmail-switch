#!/bin/sh

# bearmail-switch - part of bearmail
# # Copyright (C) 2009 Bearstech - http://bearstech.com/
# #
# # This program is free software: you can redistribute it and/or modify
# # it under the terms of the GNU General Public License as published by
# # the Free Software Foundation, either version 3 of the License, or
# # (at your option) any later version.
# #
# # This program is distributed in the hope that it will be useful,
# # but WITHOUT ANY WARRANTY; without even the implied warranty of
# # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# # GNU General Public License for more details.
# #
# # You should have received a copy of the GNU General Public License
# # along with this program.  If not, see <http://www.gnu.org/licenses/>.
#


usage() {
  cat >&2 << EOF
bearmail-switch <on|off|status|suspend>
EOF
}

BMDIR="/etc/bearmail"

PDIR="/etc/postfix"
POSTFIX_INIT="/etc/init.d/postfix"

DDIR="/etc/dovecot"
DOVECOT_INIT="/etc/init.d/dovecot"

CDIR="/etc"
CLAMSMTP_INIT="/etc/init.d/clamsmtp"

CVDIR="/etc/clamav/"
CVSOCK="/var/run/clamav/clamd.ctl"

# check if bearmail-clamav is there and correctly configured
if [ "$(grep "^## bearmail-clamav EOC" $BMDIR/postfix/master.cf)" ] ; then
  if [ ! "$(grep "^LocalSocket $CVSOCK" $CVDIR/clamd.conf)" ] ; then
    echo "Error: clamav is not configured to use socket at $CVSOCK"
    echo "Bearmail could not start."
    exit 1
  else
    BEARMAIL_CLAMAV="1"
  fi
fi


suspend() {
  SUSPEND="1"
  switch_off
}

suspend_status() {
  if [ -n "$SUSPEND" ] ; then
    $* stop
  else
    $* restart
  fi
}


switch_on() {
  is_on && { echo "Bearmail is already on."; exit 0; }

  # update of bearmail postfix configuration
  rsync -au --delete --exclude="*bearmail*" --exclude="main.cf" \
        --exclude="master.cf" $PDIR/ $BMDIR/postfix/
  mv $PDIR $PDIR.bearmail-orig
  ln -s $BMDIR/postfix $PDIR
  for bearmap in $(ls $PDIR/bearmail* | grep -v ".db"); do
    postmap $bearmap
  done
  $POSTFIX_INIT restart

  # update of bearmail dovecot configuration
  rsync -au --delete --exclude="*bearmail*" --exclude="dovecot.conf" \
        $DDIR/ $BMDIR/dovecot/
  mv $DDIR $DDIR.bearmail-orig
  ln -s $BMDIR/dovecot $DDIR
  $DOVECOT_INIT restart

  # update of bearmail clamsmtpd configuration
  if [ -n "$BEARMAIL_CLAMAV" ] ; then
    mv $CDIR/clamsmtpd.conf $CDIR/clamsmtpd.conf.bearmail-orig
    ln -s $BMDIR/clamsmtp/clamsmtpd.conf $CDIR/clamsmtpd.conf
    $CLAMSMTP_INIT restart
  fi

  # update bearmail
  ln -s $BMDIR/mailmap /etc/mailmap
  bearmail-update
  echo "Bearmail is now On."
}

switch_off() {
  is_on || { echo "Bearmail is already off.";  exit 0; }

  # update of postfix configuration
  rsync -au --delete --exclude="*bearmail*" --exclude="main.cf" \
        --exclude="master.cf" $BMDIR/postfix/ $PDIR.bearmail-orig/
  rm $PDIR
  mv $PDIR.bearmail-orig $PDIR
  suspend_status $POSTFIX_INIT

  # update of dovecot configuration
  rsync -au --delete --exclude="*bearmail*" --exclude="dovecot.conf" \
        $BMDIR/dovecot/ $DDIR.bearmail-orig/
  rm $DDIR
  mv $DDIR.bearmail-orig $DDIR
  suspend_status $DOVECOT_INIT

  # update of bearmail clamsmtpd configuration
  if [ -n "$BEARMAIL_CLAMAV" ] ; then
    rm $CDIR/clamsmtpd.conf
    mv $CDIR/clamsmtpd.conf.bearmail-orig $CDIR/clamsmtpd.conf
    suspend_status $CLAMSMTP_INIT
  fi

  # update bearmail status
  rm /etc/mailmap

  # show status
  if [ -n "$SUSPEND" ] ; then
    echo "Mailsystem is now desactivate."
  else
    echo "Bearmail is now Off."
  fi
}

is_on() {
  test -L /etc/mailmap
}

status() {
  if is_on; then
    echo "Bearmail is currently On."  
  else
    echo "Bearmail is currently Off."
  fi
}


case "$1" in
  "on")
	switch_on
	;;
  "off")
	switch_off
	;;
  "status")
	status
	;;
  "suspend")
	suspend
	;;
  *)
	usage
	status
	;;
esac
exit 0
