#!/bin/sh

# Copyright (C) 2009 Bearstech - http://bearstech.com/
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# bearmail-switch - part of bearmail

usage() {
  cat >&2 << EOF
bearmail-switch <on|off|status|suspend>
EOF
}

BMDIR="/etc/bearmail"

PDIR="/etc/postfix"
POSTFIX_INIT="/etc/init.d/postfix"

DDIR="/etc/dovecot"
DOVECOT_INIT="/etc/init.d/dovecot"

CDIR="/etc"
CLAMSMTP_INIT="/etc/init.d/clamsmtp"
CLAMAV_INIT="/etc/init.d/clamav-daemon"

CVDIR="/etc/clamav/"
CVSOCK="/var/run/clamav/clamd.ctl"

DPDIR="/etc/dspam"
DP_INIT="/etc/init.d/dspam"
PG_INIT="/etc/init.d/postgrey"

suspend_mailserver() {
  SUSPEND="1"
  switch_off
}

suspend_status() {
  if [ -n "$SUSPEND" ] ; then
    $* stop
  else
    $* restart
  fi
}

switch_on() {
  is_on && { echo "Bearmail is already on."; exit 0; }

  # check if bearmail-clamav is there and correctly configured
  if [ "$(grep "^## bearmail-clamav - EOC" $BMDIR/postfix/master.cf)" ] ; then
    if [ ! "$(grep "^LocalSocket $CVSOCK" $CVDIR/clamd.conf)" ] ; then
      echo "Error: clamav is not configured to use socket at $CVSOCK"
      suspend_mailserver
      echo "Bearmail could not start."
      exit 1
    else
      # update of bearmail clamsmtpd configuration
      if [ ! -L "$CDIR/clamsmtpd.conf" ]; then
        mv $CDIR/clamsmtpd.conf $CDIR/clamsmtpd.conf.bearmail-orig
        ln -s $BMDIR/clamsmtp/clamsmtpd.conf $CDIR/clamsmtpd.conf
        $CLAMSMTP_INIT restart
        $CLAMAV_INIT restart
      fi
    fi
  fi

  # check if dspam and postgrey are correctly configured
  if [ "$(grep "^## bearmail-antispam - EOC" $BMDIR/postfix/master.cf)" ] ; then
    if [ ! "$(grep "^PO" /etc/default/postgrey |grep "127.0.0.1:60000")" ] ; then
      echo "Error: postgrey is not configured for bearmail."
      suspend_mailserver
      echo "Bearmail could not start."
      exit 1
    fi
    # check if dspam is configured to use socket
    if [ ! "$(grep "^DeliveryPort.*10027" $BMDIR/dspam/dspam.conf)" ] || \
       [ ! "$(grep "^Se.*/var/run/dspam/dspam.sock" $BMDIR/dspam/dspam.conf)" ];\
       then
      echo "Error: dspam is not configured for bearmail."
      suspend_mailserver
      echo "Bearmail could not start."
      exit 1
    else
      # update dspam/postgrey configuration
      if [ ! -L "$DPDIR" ]; then
        rsync -au --delete --exclude="*bearmail*" --exclude="dspam.conf" \
              --exclude="default.prefs" --exclude="webfrontend.conf" \
              --exclude="dspam_tricks" $DPDIR/ $BMDIR/dspam/
        mv $DPDIR $DPDIR.bearmail-orig
        ln -s $BMDIR/dspam $DPDIR
        $DP_INIT restart
        $PG_INIT restart
      fi
    fi
  fi

  # Stop services
  $POSTFIX_INIT stop
  $DOVECOT_INIT stop
 
  # update of bearmail postfix configuration
  if [ ! -L "$PDIR" ] ; then
    rsync -au --delete --exclude="*bearmail*" --exclude="main.cf" \
          --exclude="master.cf" $PDIR/ $BMDIR/postfix/
    mv $PDIR $PDIR.bearmail-orig
    ln -s $BMDIR/postfix $PDIR
    for bearmap in $(ls $PDIR/bearmail* | grep -v ".db"); do
      postmap $bearmap
    done
  fi

  # update of bearmail dovecot configuration
  if [ ! -L "$DDIR" ] ; then
    rsync -au --delete --exclude="*bearmail*" --exclude="dovecot.conf" \
          $DDIR/ $BMDIR/dovecot/
    mv $DDIR $DDIR.bearmail-orig
    ln -s $BMDIR/dovecot $DDIR
  fi

  # update bearmail
  ln -s $BMDIR/mailmap /etc/mailmap
  bearmail-update

  # restart services
  $POSTFIX_INIT restart
  $DOVECOT_INIT restart
  echo "Bearmail is now On."
}

switch_off() {
  # update of postfix configuration
  if [ -d "$PDIR.bearmail-orig" ] ; then
    rsync -au --delete --exclude="*bearmail*" --exclude="main.cf" \
          --exclude="master.cf" $BMDIR/postfix/ $PDIR.bearmail-orig/
    rm $PDIR
    mv $PDIR.bearmail-orig $PDIR
    suspend_status $POSTFIX_INIT
  fi

  # update of dovecot configuration
  if [ -d "$DDIR.bearmail-orig" ]; then
    rsync -au --delete --exclude="*bearmail*" --exclude="dovecot.conf" \
          $BMDIR/dovecot/ $DDIR.bearmail-orig/
    rm $DDIR
    mv $DDIR.bearmail-orig $DDIR
    suspend_status $DOVECOT_INIT
  fi

  # update of bearmail clamsmtpd configuration
  if [ -f "$CDIR/clamsmtpd.conf.bearmail-orig" ] ; then
    rm $CDIR/clamsmtpd.conf
    mv $CDIR/clamsmtpd.conf.bearmail-orig $CDIR/clamsmtpd.conf
    suspend_status $CLAMSMTP_INIT
  fi

  if [ -d "$DPDIR.bearmail-orig" ] ; then
    rsync -au --delete --exclude="*bearmail*" --exclude="dspam.conf" \
          --exclude="default.prefs" --exclude="webfrontend.conf" \
          --exclude="dspam_tricks" $BMDIR/dspam/ $DPDIR.bearmail-orig/
    rm $DPDIR
    mv $DPDIR.bearmail-orig $DPDIR
    suspend_status $DP_INIT
    suspend_status $PG_INIT
  fi

  # update bearmail status
  rm -f /etc/mailmap

  # show status
  if [ -n "$SUSPEND" ] ; then
    echo "Mailsystem is now desactivate."
  else
    echo "Bearmail is Off."
  fi
}

is_on() {
  test -L /etc/mailmap
}

status() {
  if is_on; then
    echo "Bearmail is currently On."  
  else
    echo "Bearmail is currently Off."
  fi
}


case "$1" in
  "on")
	switch_on
	;;
  "off")
	switch_off
	;;
  "status")
	status
	;;
  "suspend")
	suspend_mailserver
	;;
  *)
	usage
	status
	;;
esac
exit 0
